<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent API æµ‹è¯•é¡µé¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 30px;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
    }

    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .test-section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    button:hover {
      background: #764ba2;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #333;
    }

    .log-entry {
      margin-bottom: 10px;
      padding: 5px 0;
      border-bottom: 1px solid #333;
    }

    .log-time {
      color: #888;
      margin-right: 10px;
    }

    .log-success {
      color: #4ec9b0;
    }

    .log-error {
      color: #f48771;
    }

    .log-info {
      color: #9cdcfe;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: bold;
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .input-group textarea {
      height: 100px;
      resize: vertical;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status-ok {
      background: #4ec9b0;
      color: white;
    }

    .status-error {
      background: #f48771;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Agent API æµ‹è¯•é¡µé¢</h1>

    <!-- API é…ç½® -->
    <div class="test-section" style="border-color: #667eea;">
      <h2>âš™ï¸ API é…ç½®</h2>
      <div class="input-group">
        <label>API Base URL:</label>
        <input type="text" id="apiBaseUrl" value="http://localhost:5001" onchange="updateApiUrl()">
      </div>
      <button onclick="updateApiUrl()">æ›´æ–° API URL</button>
      <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
    </div>

    <!-- çŠ¶æ€æ£€æŸ¥ -->
    <div class="test-section">
      <h2>ğŸ“Š æœåŠ¡çŠ¶æ€æ£€æŸ¥</h2>
      <button onclick="checkHealth()">æ£€æŸ¥æœåŠ¡çŠ¶æ€</button>
      <button onclick="getTools()">è·å–å·¥å…·åˆ—è¡¨</button>
      <span id="healthStatus" class="status-badge" style="display:none"></span>
    </div>

    <!-- ç™»å½•æµ‹è¯• -->
    <div class="test-section">
      <h2>ğŸ” ç™»å½•æµ‹è¯•</h2>
      <div class="input-group">
        <label>ç”¨æˆ·å:</label>
        <input type="text" id="loginUsername" value="admin">
      </div>
      <div class="input-group">
        <label>å¯†ç :</label>
        <input type="password" id="loginPassword" value="admin">
      </div>
      <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ -->
    <div class="test-section">
      <h2>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢</h2>
      <div class="input-group">
        <label>ç”¨æˆ·ID:</label>
        <input type="text" id="queryUserId" value="admin">
      </div>
      <button onclick="testQueryUser()">æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</button>
    </div>

    <!-- è”ç³»äººç®¡ç† -->
    <div class="test-section">
      <h2>ğŸ‘¥ è”ç³»äººç®¡ç†</h2>
      <div class="input-group">
        <label>è”ç³»äººæ•°æ® (JSON):</label>
        <textarea id="contactData">{
  "name": "æµ‹è¯•ç”¨æˆ·",
  "gender": "ç”·",
  "relationship_type": "colleague",
  "current_location": "åŒ—äº¬"
}</textarea>
      </div>
      <button onclick="testAddContact()">æ·»åŠ è”ç³»äºº</button>
      <button onclick="testQueryContacts()">æŸ¥è¯¢è”ç³»äººåˆ—è¡¨</button>
    </div>

    <!-- æ¯æ—¥è¿åŠ¿å’Œç©¿æ­ -->
    <div class="test-section">
      <h2>ğŸŒŸ æ¯æ—¥è¿åŠ¿å’Œç©¿æ­</h2>
      <div class="input-group">
        <label>æ—¥æœŸ (YYYY-MM-DDï¼Œå¯é€‰):</label>
        <input type="text" id="fortuneDate" value="2025-01-03">
      </div>
      <button onclick="testDailyFortune()">è·å–æ¯æ—¥è¿åŠ¿å’Œç©¿æ­</button>
    </div>

    <!-- æ¶ˆè€—ç»Ÿè®¡ -->
    <div class="test-section">
      <h2>ğŸ“Š æ¶ˆè€—ç»Ÿè®¡</h2>
      <div class="input-group">
        <label>æ—¥æœŸ (å¯é€‰):</label>
        <input type="text" id="usageDate" placeholder="2025-01-03">
      </div>
      <button onclick="testUsageStats()">è·å–æ¶ˆè€—ç»Ÿè®¡</button>
    </div>

    <!-- æ™®é€šå¯¹è¯ -->
    <div class="test-section">
      <h2>ğŸ’¬ æ™®é€šå¯¹è¯</h2>
      <div class="input-group">
        <label>æ¶ˆæ¯:</label>
        <textarea id="chatMessage">ä½ å¥½ï¼Œå¸®æˆ‘æŸ¥çœ‹äººç”Ÿè§£è¯»</textarea>
      </div>
      <button onclick="testChat()">å‘é€æ¶ˆæ¯</button>
    </div>

    <!-- æ—¥å¿—è¾“å‡º -->
    <div class="test-section">
      <h2>ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
      <div class="log-container" id="logContainer">
        <div class="log-entry log-info">âœ… æ—¥å¿—å·²åˆå§‹åŒ–</div>
      </div>
    </div>
  </div>

  <script>
    // ====================================
    // API é…ç½®
    // ====================================
    // æ–¹å¼1ï¼šä»ç¯å¢ƒå˜é‡è¯»å–ï¼ˆæ¨èï¼‰
    let API_BASE_URL = window.API_BASE_URL || localStorage.getItem('API_BASE_URL') || 'http://localhost:5000';

    // åˆå§‹åŒ–è¾“å…¥æ¡†
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('apiBaseUrl').value = API_BASE_URL;
    });

    // æ–¹å¼2ï¼šä» localStorage è¯»å–ï¼ˆæ”¯æŒåŠ¨æ€ä¿®æ”¹ï¼‰
    // const API_BASE_URL = localStorage.getItem('API_BASE_URL') || 'http://localhost:5000';

    console.log(`ğŸ“ API Base URL: ${API_BASE_URL}`);

    function updateApiUrl() {
      const newUrl = document.getElementById('apiBaseUrl').value.trim();
      if (!newUrl) {
        log('âŒ API URL ä¸èƒ½ä¸ºç©º', 'error');
        return;
      }

      API_BASE_URL = newUrl;
      localStorage.setItem('API_BASE_URL', API_BASE_URL);
      log(`âœ… API URL å·²æ›´æ–°: ${API_BASE_URL}`, 'success');
    }

    async function testConnection() {
      log('ğŸ” æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
      try {
        const response = await fetch(`${API_BASE_URL}/api/health`);
        const result = await response.json();

        if (result.status === 'ok') {
          log(`âœ… è¿æ¥æˆåŠŸ: ${result.message}`, 'success');
          log(`ğŸ“ å½“å‰ API URL: ${API_BASE_URL}`, 'info');
        } else {
          log(`âŒ æœåŠ¡å¼‚å¸¸: ${result.message}`, 'error');
        }
      } catch (error) {
        log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        log(`ğŸ’¡ è¯·æ£€æŸ¥ API URL æ˜¯å¦æ­£ç¡®: ${API_BASE_URL}`, 'info');
      }
    }

    function log(message, type = 'info') {
      const container = document.getElementById('logContainer');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
    }

    function clearLog() {
      document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">âœ… æ—¥å¿—å·²æ¸…ç©º</div>';
    }

    async function callAPI(endpoint, data = {}) {
      try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (!response.ok || result.status === 'failed') {
          throw new Error(result.error_message || 'API è°ƒç”¨å¤±è´¥');
        }

        return result;
      } catch (error) {
        log(`âŒ API è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
        throw error;
      }
    }

    async function checkHealth() {
      log('ğŸ” æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...', 'info');
      try {
        const response = await fetch(`${API_BASE_URL}/api/health`);
        const result = await response.json();

        if (result.status === 'ok') {
          log(`âœ… æœåŠ¡çŠ¶æ€æ­£å¸¸: ${result.message}`, 'success');
          document.getElementById('healthStatus').textContent = 'æ­£å¸¸';
          document.getElementById('healthStatus').className = 'status-badge status-ok';
          document.getElementById('healthStatus').style.display = 'inline-block';
        }
      } catch (error) {
        log(`âŒ æœåŠ¡ä¸å¯ç”¨: ${error.message}`, 'error');
        document.getElementById('healthStatus').textContent = 'å¼‚å¸¸';
        document.getElementById('healthStatus').className = 'status-badge status-error';
        document.getElementById('healthStatus').style.display = 'inline-block';
      }
    }

    async function getTools() {
      log('ğŸ› ï¸ æ­£åœ¨è·å–å·¥å…·åˆ—è¡¨...', 'info');
      try {
        const response = await fetch(`${API_BASE_URL}/api/tools`);
        const result = await response.json();

        if (result.status === 'success') {
          log(`âœ… æ‰¾åˆ° ${result.total} ä¸ªå·¥å…·:`, 'success');
          result.tools.forEach(tool => {
            log(`  - ${tool.name}: ${tool.description.substring(0, 50)}...`, 'info');
          });
        }
      } catch (error) {
        log(`âŒ è·å–å·¥å…·åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testLogin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      log(`ğŸ” æ­£åœ¨ç™»å½• (ç”¨æˆ·å: ${username})...`, 'info');

      try {
        const result = await callAPI('/api/agent/chat', {
          tool_name: 'login',
          tool_params: {
            username: username,
            password: password
          },
          user_id: username,
          message: 'ç™»å½•'
        });

        log(`âœ… ç™»å½•æˆåŠŸ! ç”¨æˆ·ID: ${result.data.split('**ç”¨æˆ·ID**: ')[1].split('\n')[0]}`, 'success');
      } catch (error) {
        // é”™è¯¯å·²åœ¨ log ä¸­å¤„ç†
      }
    }

    async function testQueryUser() {
      const userId = document.getElementById('queryUserId').value;
      log(`ğŸ” æ­£åœ¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ (user_id: ${userId})...`, 'info');

      try {
        const result = await callAPI('/api/agent/chat', {
          tool_name: 'query_user_by_id',
          tool_params: {
            user_id: userId
          },
          user_id: userId,
          message: 'æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯'
        });

        log(`âœ… æŸ¥è¯¢æˆåŠŸ!`, 'success');
        log(result.data.substring(0, 200) + '...', 'info');
      } catch (error) {
        // é”™è¯¯å·²åœ¨ log ä¸­å¤„ç†
      }
    }

    async function testAddContact() {
      const userId = document.getElementById('loginUsername').value;
      const contactData = document.getElementById('contactData').value;

      log(`ğŸ‘¥ æ­£åœ¨æ·»åŠ è”ç³»äºº...`, 'info');

      try {
        const result = await callAPI('/api/agent/chat', {
          tool_name: 'add_contact',
          tool_params: {
            user_id: userId,
            contact_data: contactData
          },
          user_id: userId,
          message: 'æ·»åŠ è”ç³»äºº'
        });

        log(`âœ… æ·»åŠ æˆåŠŸ!`, 'success');
      } catch (error) {
        // é”™è¯¯å·²åœ¨ log ä¸­å¤„ç†
      }
    }

    async function testQueryContacts() {
      const userId = document.getElementById('loginUsername').value;
      log(`ğŸ‘¥ æ­£åœ¨æŸ¥è¯¢è”ç³»äººåˆ—è¡¨...`, 'info');

      try {
        const result = await callAPI('/api/agent/chat', {
          tool_name: 'query_contacts',
          tool_params: {
            user_id: userId
          },
          user_id: userId,
          message: 'æŸ¥è¯¢è”ç³»äººåˆ—è¡¨'
        });

        log(`âœ… æŸ¥è¯¢æˆåŠŸ!`, 'success');
      } catch (error) {
        // é”™è¯¯å·²åœ¨ log ä¸­å¤„ç†
      }
    }

    async function testDailyFortune() {
      const userId = document.getElementById('loginUsername').value;
      const date = document.getElementById('fortuneDate').value;

      log(`ğŸŒŸ æ­£åœ¨è·å–æ¯æ—¥è¿åŠ¿å’Œç©¿æ­...`, 'info');

      try {
        const result = await callAPI('/api/agent/chat', {
          tool_name: 'get_daily_fortune_and_outfit',
          tool_params: {
            user_id: userId,
            report_date: date
          },
          user_id: userId,
          message: 'è·å–æ¯æ—¥è¿åŠ¿å’Œç©¿æ­'
        });

        log(`âœ… è·å–æˆåŠŸ!`, 'success');
      } catch (error) {
        // é”™è¯¯å·²åœ¨ log ä¸­å¤„ç†
      }
    }

    async function testUsageStats() {
      const userId = document.getElementById('loginUsername').value;
      const date = document.getElementById('usageDate').value;

      log(`ğŸ“Š æ­£åœ¨è·å–æ¶ˆè€—ç»Ÿè®¡...`, 'info');

      try {
        const params = {
          admin_user_id: userId
        };

        if (date) {
          params.date_str = date;
        }

        const result = await callAPI('/api/agent/chat', {
          tool_name: 'get_usage_statistics',
          tool_params: params,
          user_id: userId,
          message: 'è·å–æ¶ˆè€—ç»Ÿè®¡'
        });

        log(`âœ… è·å–æˆåŠŸ!`, 'success');
      } catch (error) {
        // é”™è¯¯å·²åœ¨ log ä¸­å¤„ç†
      }
    }

    async function testChat() {
      const userId = document.getElementById('loginUsername').value;
      const message = document.getElementById('chatMessage').value;

      log(`ğŸ’¬ æ­£åœ¨å‘é€æ¶ˆæ¯...`, 'info');

      try {
        const result = await callAPI('/api/agent/chat', {
          message: message,
          user_id: userId
        });

        log(`âœ… å“åº”æˆåŠŸ!`, 'success');
        log(result.data.substring(0, 300) + '...', 'info');
      } catch (error) {
        // é”™è¯¯å·²åœ¨ log ä¸­å¤„ç†
      }
    }

    async function runAllTests() {
      clearLog();
      log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'info');

      try {
        await checkHealth();
        await new Promise(r => setTimeout(r, 500));

        await getTools();
        await new Promise(r => setTimeout(r, 500));

        await testLogin();
        await new Promise(r => setTimeout(r, 500));

        await testQueryUser();
        await new Promise(r => setTimeout(r, 500));

        await testAddContact();
        await new Promise(r => setTimeout(r, 500));

        await testQueryContacts();
        await new Promise(r => setTimeout(r, 500));

        await testDailyFortune();
        await new Promise(r => setTimeout(r, 500));

        log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ!', 'success');
      } catch (error) {
        log('âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€
    window.onload = function() {
      checkHealth();
    };
  </script>
</body>
</html>
