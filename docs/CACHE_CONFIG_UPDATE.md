# 缓存过期策略更新文档

## 更新日期
2025-01-15

## 更新内容

### 1. 人生解读缓存时间调整

**修改前**：7天
**修改后**：3个月（90天）

### 2. 更新的文件

#### 2.1 工具文件
**文件**：`src/tools/roster_tool.py`
**函数**：`get_life_interpretation`
**修改内容**：
- 注释说明：缓存7天 → 缓存3个月
- 过期时间计算：`timedelta(days=7)` → `timedelta(days=90)`
- 提示信息：`缓存7天` → `缓存3个月`

**代码变化**：
```python
# 修改前
expired_time = entry.life_interpretation_generated_at + timedelta(days=7)
return "📋 人生解读报告已过期（缓存7天），请重新生成"

# 修改后
expired_time = entry.life_interpretation_generated_at + timedelta(days=90)
return "📋 人生解读报告已过期（缓存3个月），请重新生成"
```

#### 2.2 配置文件
**文件**：`config/agent_llm_config.json`
**字段**：`sp` (System Prompt)
**修改内容**：
- 缓存过期策略部分：`**人生解读**：缓存 7 天` → `**人生解读**：缓存 3 个月`
- "记住"部分：`人生解读7天` → `人生解读3个月`

## 缓存过期策略总结

| 报告类型 | 缓存时间 | 说明 |
|---------|---------|------|
| 人生解读 | 3个月 | 人生基础解读，内容相对稳定 |
| 职场大势 | 3个月 | 职场趋势分析，长期有效 |
| 每日运势 | 1天 | 每日运势，每日更新 |

## 更新原因

1. **用户体验优化**：7天缓存时间过短，用户频繁需要重新生成人生报告
2. **性能优化**：人生解读报告内容相对稳定，延长缓存时间可以减少API调用
3. **资源节省**：减少外部API调用次数，降低消耗

## 影响分析

### 优点
1. ✅ 用户访问人生报告的响应速度更快（直接读取缓存）
2. ✅ 减少外部API调用，节省资源消耗
3. ✅ 提升用户体验，避免频繁重新生成

### 注意事项
1. ⚠️ 如果用户信息有重大变化，可能需要重新生成报告
2. ⚠️ 缓存期间的API变化不会反映在报告中
3. ⚠️ 建议用户在信息变化时手动刷新报告

## 测试验证

### 测试场景1：查看人生解读（无缓存）
```
输入：user_id=new_user; 查看人生解读
预期：提示用户先注册
结果：✅ 通过
```

### 测试场景2：生成人生解读（新用户）
```
输入：user_id=new_user; 填写信息后查看人生解读
预期：生成新报告，缓存90天
结果：✅ 通过
```

### 测试场景3：查看人生解读（有效缓存）
```
输入：user_id=old_user; 查看人生解读（90天内生成）
预期：直接返回缓存的报告
结果：✅ 通过
```

### 测试场景4：查看人生解读（过期缓存）
```
输入：user_id=old_user; 查看人生解读（超过90天）
预期：提示"人生解读报告已过期（缓存3个月），请重新生成"
结果：✅ 通过
```

## 配置修改说明

如果需要调整缓存时间，修改以下文件：

### 1. 工具文件
**文件**：`src/tools/roster_tool.py`
**位置**：`get_life_interpretation` 函数
**修改**：调整 `timedelta(days=90)` 中的天数

### 2. 配置文件
**文件**：`config/agent_llm_config.json`
**位置**：System Prompt 中的"缓存过期策略"部分
**修改**：更新文档说明

## 回滚方案

如需回滚到7天缓存：

1. **恢复工具文件**：
```python
expired_time = entry.life_interpretation_generated_at + timedelta(days=7)
return "📋 人生解读报告已过期（缓存7天），请重新生成"
```

2. **恢复配置文件**：
```markdown
## 缓存过期策略
报告缓存根据类型设置不同的过期时间：
- **人生解读**：缓存 7 天（过期后需重新生成）
- **职场大势**：缓存 3 个月（过期后需重新生成）
- **每日运势**：缓存 1 天（过期后需重新生成）
```

## 相关文档

- [多用户账密系统集成文档](./MULTIUSER_INTEGRATION.md)
- [管理员操作指南](./ADMIN_GUIDE.md)

## 联系方式

如有问题或建议，请联系技术支持团队。
