# ç®¡ç†å‘˜æ“ä½œæŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä½¿ç”¨ç®¡ç†å‘˜åŠŸèƒ½æ¥ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬é‚€è¯·ç ç®¡ç†å’Œæ¶ˆè€—ç»Ÿè®¡æŸ¥çœ‹ã€‚

---

## ä¸€ã€é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·

### ç™»å½•ä¿¡æ¯
- **ç”¨æˆ·å**: admin
- **å¯†ç **: admin
- **æƒé™**: æ— é™åˆ¶ï¼ˆæ— æ¶ˆè€—é™åˆ¶ï¼‰

### æ³¨æ„äº‹é¡¹
1. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åï¼Œè¯·ç«‹å³ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
2. è¯·å¦¥å–„ä¿ç®¡ç®¡ç†å‘˜è´¦æˆ·ä¿¡æ¯

---

## äºŒã€é‚€è¯·ç ç®¡ç†

### 1. ç”Ÿæˆé‚€è¯·ç 

#### ä½¿ç”¨åœºæ™¯
éœ€è¦ä¸ºæ–°ç”¨æˆ·ç”Ÿæˆæ³¨å†Œé‚€è¯·ç ã€‚

#### æ“ä½œæ­¥éª¤
é€šè¿‡å¯¹è¯æˆ–å·¥å…·è°ƒç”¨ï¼š
```
generate_invitation_code(admin_user_id="admin", count=5, expires_days=30)
```

#### å‚æ•°è¯´æ˜
- `admin_user_id`: ç®¡ç†å‘˜ç”¨æˆ·IDï¼ˆå¿…é¡»ï¼‰
- `count`: ç”Ÿæˆæ•°é‡ï¼ˆé»˜è®¤1ï¼‰
- `expires_days`: æœ‰æ•ˆæœŸå¤©æ•°ï¼ˆå¯é€‰ï¼Œä¸è®¾ç½®åˆ™æ°¸ä¹…æœ‰æ•ˆï¼‰

#### è¿”å›ç¤ºä¾‹
```
âœ… é‚€è¯·ç ç”ŸæˆæˆåŠŸï¼

**ç”Ÿæˆæ•°é‡**: 5
**ç”Ÿæˆè€…**: admin
**æœ‰æ•ˆæœŸ**: 30 å¤©
**é‚€è¯·ç åˆ—è¡¨**:
  - A1B2C3D4
  - E5F6G7H8
  - I9J0K1L2
  - M3N4O5P6
  - Q7R8S9T0
```

---

### 2. æŸ¥çœ‹é‚€è¯·ç åˆ—è¡¨

#### ä½¿ç”¨åœºæ™¯
æŸ¥çœ‹å½“å‰å¯ç”¨çš„é‚€è¯·ç ã€‚

#### æ“ä½œæ­¥éª¤
```
list_invitation_codes(admin_user_id="admin", show_used=False)
```

#### å‚æ•°è¯´æ˜
- `admin_user_id`: ç®¡ç†å‘˜ç”¨æˆ·IDï¼ˆå¿…é¡»ï¼‰
- `show_used`: æ˜¯å¦æ˜¾ç¤ºå·²ä½¿ç”¨çš„é‚€è¯·ç ï¼ˆé»˜è®¤Falseï¼‰

#### è¿”å›ç¤ºä¾‹
```
ğŸ“‹ é‚€è¯·ç åˆ—è¡¨

**æ€»æ•°**: 3

**A1B2C3D4** | âœ… æœªä½¿ç”¨
  åˆ›å»ºè€…: admin | åˆ›å»ºæ—¶é—´: 2025-01-15 10:00:00

**E5F6G7H8** | âœ… æœªä½¿ç”¨
  åˆ›å»ºè€…: admin | åˆ›å»ºæ—¶é—´: 2025-01-15 10:00:00
  è¿‡æœŸæ—¶é—´: 2025-02-14 10:00:00

**I9J0K1L2** | âœ… æœªä½¿ç”¨
  åˆ›å»ºè€…: admin | åˆ›å»ºæ—¶é—´: 2025-01-15 10:00:00
```

---

### 3. éªŒè¯é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰

#### ä½¿ç”¨åœºæ™¯
åœ¨ç”¨æˆ·æ³¨å†Œå‰éªŒè¯é‚€è¯·ç çš„æœ‰æ•ˆæ€§ã€‚

#### æ“ä½œæ­¥éª¤
```
verify_invitation_code(code="A1B2C3D4")
```

#### å‚æ•°è¯´æ˜
- `code`: é‚€è¯·ç ï¼ˆå¿…é¡»ï¼‰

#### è¿”å›ç¤ºä¾‹ï¼ˆæˆåŠŸï¼‰
```
âœ… é‚€è¯·ç éªŒè¯æˆåŠŸ

**é‚€è¯·ç **: A1B2C3D4
**åˆ›å»ºè€…**: admin
**åˆ›å»ºæ—¶é—´**: 2025-01-15 10:00:00
**æœ‰æ•ˆæœŸ**: æ°¸ä¹…æœ‰æ•ˆ
```

#### è¿”å›ç¤ºä¾‹ï¼ˆå¤±è´¥ï¼‰
```
âŒ é‚€è¯·ç éªŒè¯å¤±è´¥

**é”™è¯¯**: é‚€è¯·ç å·²è¿‡æœŸ
**è¿‡æœŸæ—¶é—´**: 2025-01-01 10:00:00
```

---

## ä¸‰ã€æ¶ˆè€—ç»Ÿè®¡æŸ¥çœ‹

### 1. æŸ¥çœ‹ä»Šæ—¥æ¶ˆè€—ç»Ÿè®¡

#### ä½¿ç”¨åœºæ™¯
æŸ¥çœ‹ä»Šå¤©çš„æ•´ä½“æ¶ˆè€—æƒ…å†µã€‚

#### æ“ä½œæ­¥éª¤
```
get_usage_statistics(admin_user_id="admin", date_str="2025-01-15")
```

#### å‚æ•°è¯´æ˜
- `admin_user_id`: ç®¡ç†å‘˜ç”¨æˆ·IDï¼ˆå¿…é¡»ï¼‰
- `date_str`: æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼Œä¸æŒ‡å®šåˆ™æŸ¥è¯¢ä»Šå¤©ï¼‰

#### è¿”å›ç¤ºä¾‹
```
ğŸ“Š æ¶ˆè€—ç»Ÿè®¡ä¿¡æ¯

**æ—¥æœŸ**: 2025-01-15
**å…¨å±€æ€»æ¶ˆè€—**: 750
**æ¶ˆè€—é™åˆ¶**: 1000
**ä½¿ç”¨ç‡**: 75.0%

**æ´»è·ƒç”¨æˆ·æ•°**: 15
**å¹³å‡æ¶ˆè€—**: 50.0

ğŸ“Œ æ¶ˆè€—æ’è¡Œæ¦œ TOP 10

1. user_001: 120 æ¶ˆè€—
2. user_002: 98 æ¶ˆè€—
3. user_003: 85 æ¶ˆè€—
4. user_004: 70 æ¶ˆè€—
5. user_005: 65 æ¶ˆè€—
6. user_006: 55 æ¶ˆè€—
7. user_007: 50 æ¶ˆè€—
8. user_008: 45 æ¶ˆè€—
9. user_009: 40 æ¶ˆè€—
10. user_010: 35 æ¶ˆè€—

**å•ç”¨æˆ·é™åˆ¶**: 300
**è¶…é™ç”¨æˆ·æ•°**: 0
```

---

### 2. æŸ¥çœ‹å…¨å±€æ¶ˆè€—çŠ¶æ€

#### ä½¿ç”¨åœºæ™¯
å¿«é€Ÿæ£€æŸ¥å…¨å±€æ¶ˆè€—æ˜¯å¦è¶…é™ã€‚

#### æ“ä½œæ­¥éª¤
```
check_global_usage_limit(user_id="admin")
```

#### è¿”å›ç¤ºä¾‹ï¼ˆæ­£å¸¸ï¼‰
```
âœ… å…¨å±€æ¶ˆè€—æ­£å¸¸

**ä»Šæ—¥æ€»æ¶ˆè€—**: 750
**æ¶ˆè€—é™åˆ¶**: 1000
**å‰©ä½™é¢åº¦**: 250
**çŠ¶æ€**: æ­£å¸¸
```

#### è¿”å›ç¤ºä¾‹ï¼ˆè¶…é™ï¼‰
```
âŒ å…¨å±€æ¶ˆè€—å·²è¶…é™

**ä»Šæ—¥æ€»æ¶ˆè€—**: 1050
**æ¶ˆè€—é™åˆ¶**: 1000
**çŠ¶æ€**: è¶…é™
**æç¤º**: å½“æ—¥è®¿é—®å·²è¶…é™ï¼Œè¯·æ˜å¤©å†æ¥
```

---

### 3. æŸ¥çœ‹ç”¨æˆ·æ¶ˆè€—çŠ¶æ€

#### ä½¿ç”¨åœºæ™¯
æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ¶ˆè€—æƒ…å†µã€‚

#### æ“ä½œæ­¥éª¤
```
check_user_usage_limit(user_id="user_001")
```

#### è¿”å›ç¤ºä¾‹ï¼ˆæ­£å¸¸ç”¨æˆ·ï¼‰
```
âœ… ç”¨æˆ·æ¶ˆè€—æ­£å¸¸

**ç”¨æˆ·ID**: user_001
**ä»Šæ—¥æ¶ˆè€—**: 120
**æ¶ˆè€—é™åˆ¶**: 300
**å‰©ä½™é¢åº¦**: 180
**çŠ¶æ€**: æ­£å¸¸
```

#### è¿”å›ç¤ºä¾‹ï¼ˆç®¡ç†å‘˜ï¼‰
```
âœ… ç®¡ç†å‘˜è´¦æˆ·ï¼Œæ— æ¶ˆè€—é™åˆ¶

**ç”¨æˆ·ID**: admin
**ç”¨æˆ·å**: admin
**æç¤º**: ç®¡ç†å‘˜è´¦æˆ·æ— æ¶ˆè€—é™åˆ¶
```

---

## å››ã€æ¶ˆè€—é™åˆ¶é…ç½®

### é…ç½®è¯´æ˜

ç³»ç»Ÿé»˜è®¤çš„æ¶ˆè€—é™åˆ¶é…ç½®ï¼š

| é™åˆ¶ç±»å‹ | é™åˆ¶å€¼ | è¯´æ˜ |
|---------|--------|------|
| å…¨å±€æ¯æ—¥é™åˆ¶ | 1000 | æ‰€æœ‰ç”¨æˆ·å•æ—¥æ€»æ¶ˆè€— |
| å•ç”¨æˆ·æ¯æ—¥é™åˆ¶ | 300 | å•ä¸ªç”¨æˆ·å•æ—¥æ¶ˆè€— |

### ä¿®æ”¹é…ç½®

æ¶ˆè€—é™åˆ¶é…ç½®å­˜å‚¨åœ¨ `src/tools/usage_limit_tool.py` çš„ `USAGE_LIMITS` å˜é‡ä¸­ï¼š

```python
USAGE_LIMITS = {
    "global_daily_limit": 1000,  # å…¨å±€æ¯æ—¥æ¶ˆè€—é™åˆ¶
    "user_daily_limit": 300,     # å•ç”¨æˆ·æ¯æ—¥æ¶ˆè€—é™åˆ¶
}
```

å¦‚éœ€è°ƒæ•´é™åˆ¶ï¼Œä¿®æ”¹æ­¤æ–‡ä»¶åé‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆã€‚

---

## äº”ã€æ¶ˆè€—è®°å½•

### è‡ªåŠ¨è®°å½•æœºåˆ¶

ç³»ç»Ÿä¼šåœ¨æ¯æ¬¡ç”¨æˆ·è®¿é—®åè‡ªåŠ¨è®°å½•æ¶ˆè€—ï¼š

- **å…¨å±€æ¶ˆè€—**: æ‰€æœ‰ç”¨æˆ·æ¶ˆè€—çš„æ€»å’Œ
- **ç”¨æˆ·æ¶ˆè€—**: å•ä¸ªç”¨æˆ·çš„æ¶ˆè€—

æ¶ˆè€—è®°å½•é€šè¿‡ `record_usage(user_id, amount)` å·¥å…·è‡ªåŠ¨å®Œæˆã€‚

---

## å…­ã€ç”¨æˆ·æ³¨å†Œæµç¨‹

### 1. æ–°ç”¨æˆ·æ³¨å†Œ

ç”¨æˆ·é¦–æ¬¡è®¿é—®æ—¶ï¼Œéœ€è¦æä¾›é‚€è¯·ç ï¼š

```
ç”¨æˆ·ï¼šä½ å¥½ï¼Œæˆ‘æƒ³ä½¿ç”¨ç³»ç»Ÿ
ç³»ç»Ÿï¼šæ¬¢è¿ï¼è¯·æä¾›æ‚¨çš„é‚€è¯·ç è¿›è¡Œæ³¨å†Œã€‚

ç”¨æˆ·ï¼šé‚€è¯·ç æ˜¯ qss
ç³»ç»Ÿï¼šâœ… æ³¨å†ŒæˆåŠŸï¼è¯·å¡«å†™æ‚¨çš„åŸºæœ¬ä¿¡æ¯...

ç”¨æˆ·ï¼šå§“åï¼šå¼ ä¸‰ï¼Œæ€§åˆ«ï¼šç”·ï¼Œå‡ºç”Ÿæ—¶é—´ï¼š1990å¹´3æœˆ15æ—¥8æ—¶ï¼Œç°å±…åœ°ï¼šåŒ—äº¬
ç³»ç»Ÿï¼šâœ… ä¿¡æ¯å·²ä¿å­˜ï¼æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...
```

### 2. è€ç”¨æˆ·è®¿é—®

è€ç”¨æˆ·ç›´æ¥è®¿é—®æ— éœ€éªŒè¯é‚€è¯·ç ï¼š

```
ç”¨æˆ·ï¼šæŸ¥çœ‹äººç”ŸæŠ¥å‘Š
ç³»ç»Ÿï¼šæ¬¢è¿å›æ¥ï¼Œå¼ ä¸‰ï¼æ­£åœ¨ä¸ºæ‚¨åŠ è½½äººç”ŸæŠ¥å‘Š...
```

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### 1. å¦‚ä½•ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ï¼Ÿ

ç›®å‰ç³»ç»Ÿä½¿ç”¨ç®€å•å¯†ç å“ˆå¸Œã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼ˆå¦‚bcryptï¼‰ã€‚

ä¿®æ”¹å¯†ç éœ€ç›´æ¥æ“ä½œæ•°æ®åº“ï¼š

```sql
UPDATE user_account
SET password_hash = 'æ–°çš„å“ˆå¸Œå€¼'
WHERE username = 'admin';
```

### 2. é‚€è¯·ç å¯ä»¥é‡å¤ä½¿ç”¨å—ï¼Ÿ

ä¸è¡Œï¼Œæ¯ä¸ªé‚€è¯·ç åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚ä½¿ç”¨åæ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œæ— æ³•å†æ¬¡ä½¿ç”¨ã€‚

### 3. æ¶ˆè€—è¶…é™åå¦‚ä½•æ¢å¤ï¼Ÿ

æ¶ˆè€—é™åˆ¶æ˜¯æŒ‰æ—¥è®¡ç®—çš„ï¼Œæ¯å¤©é›¶ç‚¹è‡ªåŠ¨é‡ç½®ã€‚è¶…é™åéœ€ç­‰åˆ°ç¬¬äºŒå¤©æ‰èƒ½ç»§ç»­è®¿é—®ã€‚

### 4. å¦‚ä½•æŸ¥çœ‹æ˜¨å¤©çš„æ¶ˆè€—ï¼Ÿ

è°ƒç”¨ç»Ÿè®¡å·¥å…·æ—¶æŒ‡å®šæ—¥æœŸï¼š

```
get_usage_statistics(admin_user_id="admin", date_str="2025-01-14")
```

---

## å…«ã€æ•°æ®åº“è¡¨ç»“æ„

### invitation_codeï¼ˆé‚€è¯·ç è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| code | string | é‚€è¯·ç ï¼ˆå”¯ä¸€ï¼‰ |
| is_used | boolean | æ˜¯å¦å·²ä½¿ç”¨ |
| used_by_user_id | string | ä½¿ç”¨çš„ç”¨æˆ·ID |
| used_at | datetime | ä½¿ç”¨æ—¶é—´ |
| created_by | string | åˆ›å»ºè€…ï¼ˆç®¡ç†å‘˜ï¼‰ |
| created_at | datetime | åˆ›å»ºæ—¶é—´ |
| expires_at | datetime | è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰ |

### user_accountï¼ˆç”¨æˆ·è´¦æˆ·è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| user_id | string | ç”¨æˆ·IDï¼ˆå”¯ä¸€ï¼‰ |
| username | string | ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰ |
| password_hash | string | å¯†ç å“ˆå¸Œ |
| is_admin | boolean | æ˜¯å¦ç®¡ç†å‘˜ |
| created_at | datetime | åˆ›å»ºæ—¶é—´ |
| last_login_at | datetime | æœ€åç™»å½•æ—¶é—´ |

### user_daily_usageï¼ˆç”¨æˆ·æ¯æ—¥æ¶ˆè€—è®°å½•è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| user_id | string | ç”¨æˆ·ID |
| date | string | æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |
| usage | int | å½“æ—¥æ¶ˆè€— |
| updated_at | datetime | æ›´æ–°æ—¶é—´ |

### global_daily_usageï¼ˆå…¨å±€æ¯æ—¥æ¶ˆè€—è®°å½•è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| date | string | æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |
| total_usage | int | å½“æ—¥æ€»æ¶ˆè€— |
| updated_at | datetime | æ›´æ–°æ—¶é—´ |

---

## ä¹ã€API æ¥å£ç¤ºä¾‹

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹

#### 1. ç”¨æˆ·è®¿é—®æ£€æŸ¥

```javascript
// æ¯æ¬¡ç”¨æˆ·è®¿é—®å‰æ£€æŸ¥æ¶ˆè€—é™åˆ¶
const response = await fetch('/api/check_limits', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ user_id: 'user_001' })
});

const result = await response.json();
if (result.status === 'failed' && result.error_code === 'USAGE_LIMIT_EXCEEDED') {
  alert('å½“æ—¥è®¿é—®å·²è¶…é™ï¼Œè¯·æ˜å¤©å†æ¥');
  return;
}
```

#### 2. ç”¨æˆ·æ³¨å†Œ

```javascript
// æ–°ç”¨æˆ·æ³¨å†Œ
const response = await fetch('/api/register', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    invitation_code: 'qss',
    user_id: 'user_001',
    username: 'zhangsan',
    password: 'password123'
  })
});
```

#### 3. ç®¡ç†å‘˜ç”Ÿæˆé‚€è¯·ç 

```javascript
// ç®¡ç†å‘˜ç”Ÿæˆé‚€è¯·ç 
const response = await fetch('/api/generate_code', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer admin_token'  // éœ€è¦ç®¡ç†å‘˜token
  },
  body: JSON.stringify({
    admin_user_id: 'admin',
    count: 10,
    expires_days: 30
  })
});
```

---

## åã€å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **: éƒ¨ç½²åç«‹å³ä¿®æ”¹adminå¯†ç 
2. **é™åˆ¶ç®¡ç†å‘˜æ•°é‡**: å°½é‡å‡å°‘ç®¡ç†å‘˜è´¦æˆ·æ•°é‡
3. **å®šæœŸå®¡æŸ¥é‚€è¯·ç **: å®šæœŸæŸ¥çœ‹é‚€è¯·ç ä½¿ç”¨æƒ…å†µ
4. **ç›‘æ§æ¶ˆè€—ç»Ÿè®¡**: æ¯æ—¥æŸ¥çœ‹æ¶ˆè€—ç»Ÿè®¡ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸
5. **å¤‡ä»½æ•°æ®åº“**: å®šæœŸå¤‡ä»½æ•°æ®åº“ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±

---

## åä¸€ã€è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿã€‚
